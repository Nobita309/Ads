
name: adblock

on:
  schedule:
    - cron: '0 */1 * * *'
  workflow_dispatch:

permissions:
  actions: write
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure jq is available
        run: |
          set -euo pipefail

      - name: Delete previous workflow runs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PREVIOUS_RUNS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs" | \
            jq -r '.workflow_runs[] | select(.status == "completed") | .id')
          for run_id in $PREVIOUS_RUNS; do
            echo "Deleting workflow run ID: $run_id"
            curl -s -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/$run_id"
          done || true

      - name: Install Mihomo (auto-detect asset, prefer .deb, fallback .gz)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          arch="$(dpkg --print-architecture)"

          if [ -n "${VERSION:-}" ]; then
            echo "Using fixed tag: ${VERSION}"
            rel_json=$(curl -fsSL -H "Authorization: token ${GITHUB_TOKEN}" \
              "https://api.github.com/repos/MetaCubeX/mihomo/releases/tags/${VERSION}")
          else
            echo "Fetching latest release"
            rel_json=$(curl -fsSL -H "Authorization: token ${GITHUB_TOKEN}" \
              "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest")
          fi

          deb_url=$(echo "$rel_json" | jq -r \
            --arg arch "$arch" --arg ch "$channel" '
              .assets[]
              | select(.name | test("^mihomo-linux-" + $arch + "-" + $ch))
              | select(.name | endswith(".deb"))
              | .browser_download_url
            ' | head -n 1)

          gz_url=$(echo "$rel_json" | jq -r \
            --arg arch "$arch" --arg ch "$channel" '
              .assets[]
              | select(.name | test("^mihomo-linux-" + $arch + "-"))
              | select(.name | endswith(".gz"))
              | .browser_download_url
            ' | head -n 1)


          gz_url=$(echo "$rel_json" | jq -r \
            --arg arch "$arch" '
              .assets[]
              | select(.name | test("^mihomo-linux-" + $arch + "-"))
              | select(.name | endswith(".gz"))
              | .browser_download_url
            ' | head -n 1)

          if [ -n "$deb_url" ] && [ "$deb_url" != "null" ]; then
            echo "Downloading .deb: $deb_url"
            curl -fsSL -o mihomo.deb "$deb_url"
            sudo dpkg -i mihomo.deb || (sudo apt-get update && sudo apt-get -f install -y && sudo dpkg -i mihomo.deb)
            rm -f mihomo.deb
          elif [ -n "$gz_url" ] && [ "$gz_url" != "null" ]; then
            echo "Downloading .gz: $gz_url"
            curl -fsSL -o mihomo.gz "$gz_url"
            gunzip -c mihomo.gz > mihomo
            rm -f mihomo.gz
            chmod +x mihomo
            sudo mv mihomo /usr/local/bin/mihomo
          else
            echo "No matching asset found for linux-$arch (.deb/.gz) in latest release." >&2
            echo "$rel_json" | jq '{tag_name, assets: [.assets[].name]}'
            exit 1
          fi

          echo "Installed Mihomo version:"
          (mihomo -v || /usr/bin/mihomo -v || true)

      - name: Download and convert TXT to MRS in parallel
        run: |
          set -euo pipefail

          conv() {
            URL="$1"; OUT="$2"
            echo "Fetching $URL -> ${OUT}.txt"
            curl -fsSL "$URL" -o "${OUT}.txt"
            echo "Converting ${OUT}.txt -> ${OUT}.mrs"
            mihomo convert-ruleset domain text "${OUT}.txt" "${OUT}.mrs"
            rm -f "${OUT}.txt"
            echo "Converted ${OUT}.mrs"
          }

          conv "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/wildcard/pro.txt" pro &
          conv "https://big.oisd.nl/domainswild" oisd &
          conv "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/wildcard/tif.txt" tif &
          wait

      - name: Commit and push if there are changes
        run: |
          set -euo pipefail
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add *.mrs || true
          if ! git diff --staged --quiet; then
            git commit -m "Update adblock MRS files"
            git push
          else
            echo "No changes to commit."
          fi
